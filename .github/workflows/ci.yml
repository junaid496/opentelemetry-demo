name: CI for OpenTelemetry Demo

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate-yamls:
    name: Validate YAML Files
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Validate YAML syntax
      run: |
        echo "üîç Checking YAML files in kubernetes/ directory..."
        if [ -d "kubernetes" ]; then
          find kubernetes/ -name "*.yaml" -o -name "*.yml" | while read file; do
            echo "Validating: $file"
            python3 -c "import yaml; yaml.safe_load(open('$file'))" && echo "‚úÖ $file - Valid"
          done
        else
          echo "‚ùå kubernetes/ directory not found"
          exit 1
        fi

  notify-argocd:
    name: Trigger ArgoCD Sync
    needs: validate-yamls
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
    - name: Sync ArgoCD Application
      run: |
        echo "üöÄ Triggering ArgoCD Sync..."
        curl -k -X POST \
          "https://a5cde3e6cf64645d4b9f39093b86736c-1645307027.us-east-1.elb.amazonaws.com/api/v1/applications/otel-demo/sync" \
          -H "Authorization: Bearer ${{ secrets.ARGOCD_TOKEN }}" \
          -H "Content-Type: application/json"
        echo "‚úÖ ArgoCD sync triggered successfully!"
