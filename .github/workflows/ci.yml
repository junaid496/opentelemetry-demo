name: CI for OpenTelemetry Demo

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate-yamls:
    name: Validate YAML Files
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Validate YAML syntax
      run: |
        echo "üîç Checking YAML files..."
        if [ -d "kubernetes" ]; then
          find kubernetes/ -name "*.yaml" -o -name "*.yml" | while read file; do
            echo "Validating: $file"
            python3 -c "
import yaml
try:
    with open('$file') as f:
        documents = list(yaml.safe_load_all(f))
    print('‚úÖ $file - Valid (' + str(len(documents)) + ' documents)')
except Exception as e:
    print('‚ùå $file - Error:', str(e))
    exit(1)
            "
          done
        else
          echo "‚ùå kubernetes/ directory not found"
          exit 1
        fi

  notify-argocd:
    name: Trigger ArgoCD Sync
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
    - name: Sync ArgoCD Application
      run: |
        echo "üöÄ Triggering ArgoCD Sync..."
        echo "üìù Commit: ${{ github.sha }}"
        
        # Sync API call with better error handling
        response=$(curl -k -s -o response.txt -w "%{http_code}" \
          -X POST \
          "https://a5cde3e6cf64645d4b9f39093b86736c-1645307027.us-east-1.elb.amazonaws.com/api/v1/applications/otel-demo/sync" \
          -H "Authorization: Bearer ${{ secrets.ARGOCD_TOKEN }}" \
          -H "Content-Type: application/json")
        
        echo "üì° HTTP Status: $response"
        if [ "$response" -eq 200 ]; then
          echo "‚úÖ ArgoCD sync triggered successfully!"
          cat response.txt
        else
          echo "‚ùå ArgoCD sync failed!"
          cat response.txt
          exit 1
        fi
